<!DOCTYPE html>
<html lang="en">
  <head>
  <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <meta charset="utf-8">
    <title>Graduate Admission</title>
    <script src="javascripts/d3.js"></script> 
  </head>

  <body>
    <h1 style="text-align:center;">Visualization for beverages sales in the US</h1>
    <h2 style="text-align:center;">IE5900 Data Visualization Hw4 - Spring 2015</h2>
    <h3 style="text-align:center;">Manuel Ramirez</h2>

    <script>
      width=900;
      height=500;
      var color = d3.scale.category20b();

      //Create svg
      var mySvg= d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

      //Create treemap layout
      var myTreemap= d3.layout.treemap()
        .size([width,height])
        .sticky(true)
        .padding(0)
        .value(function(d) {return +d.values.totProfit; })    
        .children(function(d) {return d.values; });

      //Read dataser 
      d3.csv("https://hivelab.org/static/coffee.csv", function(data) {
        //Nest dataser
        var nest=d3.nest()
                    .key(function(d){ return "grandpa";})
                    .key(function(d){return d.region;})
                    .key(function(d){return d.state;})
                    .key(function(d){return d.category;})
                    .rollup(function(d){return {totProfit: d3.sum(d,function(d){return d.profit;}), totSales: d3.sum(d, function(d){return d.sales;})}})
                    .entries(data);

        //Create rectangles
        mySvg.selectAll("rect")
          .data(myTreemap.nodes(nest[0]))
          .enter()
          .append("rect")
            .attr("x", function(d){return d.x;})
            .attr("y", function(d){return d.y;})
            .attr("width", function(d){return d.dx;})
            .attr("height", function(d){return d.dy;})
            .attr("stroke",function(d){return !d.children? "white": d.children[0].children? "black": null;})
            .attr("fill", function(d){return d.children? "white": color(d.parent.value);})
            .append("title").text(function(d){return "Category: "+ d.key+"\n"+ "Profit: "+d.values.totProfit+"\n"+"Sales: "+d.values.totSales})

        //Create text
        mySvg.selectAll("#Values")
          .data(myTreemap.nodes(nest[0]))
          .enter()
          .append("text")
            .attr("x", function(d){return d.x+d.dx/2-20;})
            .attr("y", function(d){return d.y+d.dy/2+5;})
            .attr("fill", "black")
            .attr("style","font-size:20px")
            .text(function(d){return !d.children? null : d.children[0].children? null: d.key;});

        //Update teemap when clicking checkcircles
        d3.selectAll("input").on("change", function change() {
          var myValue = this.value === "profit"? function(d) { return d.values.totProfit; }: function(d) { return d.values.totSales; };
          
          //Update rectangles
          mySvg.selectAll("rect")
            .data(myTreemap.value(myValue))
            .transition()
            .duration(500)
            .attr("x", function(d){return d.x;})
            .attr("y", function(d){return d.y;})
            .attr("width", function(d){return d.dx;})
            .attr("height", function(d){return d.dy;});
            
          //Update text
          mySvg.selectAll("text")
            .data(myTreemap.value(myValue))
            .transition()
            .duration(500)
            .attr("x", function(d){return d.x+d.dx/2-20;})
            .attr("y", function(d){return d.y+d.dy/2+5;})
        });
      });
      
    </script>
    <form>
      <label><input type="radio" name="mode" value="profit" checked> Profit</label>
      <label><input type="radio" name="mode" value="sales"> Sales</label>
    </form>

    <div>
      <p>The previous visualizations provides an organized way to perceive profit and sales of diferent categories of hot beverages in the United States.</p>
      <p>The treemap above displays the states in an organized manner: the central states are grouped at the upper right corner, the eastern states at the upper left corner, the western states at the lower right corner and the southern states at the lower left corner.</p>
      <p>Each State is also divided according to the category of the beverage, whose names, pofits and sales can be displayed by hovering over the boxes. The categories are Tea, Espresso, Herbal Tea and Coffee.</p>
      <p>Finally, by clicking on the check circles below the visualization, the boxes would represent either the total profit or sales of each category in each state.</p>
    </div>
    
  </body>
</html>